# NetBox Connector

I put this toolkit together to make harvesting device data via Netmiko and syncing it with NetBox feel predictable and low pressure. Every run follows a review-first workflow so you can check the plan before anything touches NetBox.

## Configuration

Start by copying `settings.yaml` and `rules.yaml`, then tailor both files to match your environment.

- `settings.yaml` covers NetBox connection details, SSL verification, optional naming suffixes, and where dry-run proposal JSON files live.
- `rules.yaml` maps hostnames to roles, sites, manufacturers, device types, and interface classifications using regex-driven rules. The `device_types` section translates raw platform strings into exact NetBox slugs, while `interface_types` lets you tweak physical and LAG defaults or override by pattern.

Set the API token either directly inside `settings.yaml` or by exporting the environment variable named in `token_env` (default `NETBOX_TOKEN`).

Simulation mode automatically injects a dummy token, so you can run `--simulate` without worrying about credentials during early testing.

Required Python packages (installable with `pip install -r requirements.txt`):

- `netmiko`
- `pynetbox`
- `PyYAML`
- `urllib3`

## Usage

### Command line

The `connector_cli.py` helper drives the full workflow from a terminal:

```powershell
python connector_cli.py 192.0.2.10 nokia_sros admin --log-level INFO
```

That command runs a dry-run, saves proposal JSON to the configured directory, and prints a human-readable summary. Re-run with `--apply` (and optionally `--update-existing` if updates are allowed) to push the changes:

```powershell
python connector_cli.py 192.0.2.10 nokia_sros admin --apply --update-existing
```

You will be prompted for the SSH password unless you supply it with `--password`. Use `--settings` or `--rules` when you need to point at alternate configuration files.

Every dry-run prints a "Preflight" section summarizing any missing manufacturers, device types, or module types that would cause the apply step to fail. Fix those gaps (usually by adding slugs to NetBox or adjusting `rules.yaml`) before re-running with `--apply`.

#### Simulation mode

If you want to explore the workflow without touching a real device or NetBox instance, append `--simulate`. The CLI will generate a representative `NormalizedInventory`, run the proposal engine against an in-memory fake NetBox API, and leave the proposals on disk for inspection:

```powershell
python connector_cli.py --simulate --log-level DEBUG
```

All other options remain available in simulation; for example, you can supply alternate `settings.yaml` and `rules.yaml` files to see how different rule sets influence the generated data.

Simulation relies exclusively on local helpers, so no SSH or NetBox connectivity is required—even the API token can be omitted safely.

### NetBox Script

Within NetBox, the `CreateNetmikoTest` script gives you the same dry-run and apply behaviour directly in the UI. Leave "Commit" unchecked to export a proposal without making changes; check "Commit" (and, if necessary, "Update existing") to write the changes back to NetBox.

### Outputs

- **NormalizedInventory**: generated by the `NetmikoDataCollector` adapter.
- **ProposalBatch JSON**: saved under the `proposals/` directory during dry-run runs.
- **Apply logs**: emitted to stdout (CLI) or the NetBox script log, showing both the actions taken and the post-apply verification summary.

## Rollout checklist

1. **Finalize rules and config:** Confirm `rules.yaml` covers role, site, manufacturer, and device-type mappings for your fleet and that interface defaults match your standards.
2. **Run an offline simulation:** Execute `connector_cli.py --simulate` to study proposal JSON and the preflight report without needing credentials.
3. **Try a staging dry-run:** Point the CLI or NetBox Script at a staging NetBox, review the generated proposals, and ensure the second dry-run is a no-op.
4. **Perform a controlled apply:** Create a minimally scoped API token, export config via source control, run `--apply` in a maintenance window, and archive the proposal JSON plus logs.
5. **Iterate and expand:** Adjust rules for new locations or hardware, add adapters if you need them, and optionally wrap the same internals as a NetBox plugin for broader distribution.

Thanks for giving this connector a try—feel free to open an issue or PR if you spot a gap or want to share an improvement.

## License

Released under the MIT License. See `LICENSE` for details.
